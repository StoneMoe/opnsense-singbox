name: Build OPNsense Plugin

on:
  push:
    branches: [master]
    tags: ['v*']
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      opnsense_branch:
        description: 'OPNsense plugins branch (e.g., stable/25.7, master)'
        required: false
        default: 'stable/25.7'
      freebsd_version:
        description: 'FreeBSD version (e.g., 14.3)'
        required: false
        default: '14.3'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OPNSENSE_BRANCH: ${{ github.event.inputs.opnsense_branch || 'stable/25.7' }}
      FREEBSD_VERSION: ${{ github.event.inputs.freebsd_version || '14.3' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build plugin in FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          release: ${{ env.FREEBSD_VERSION }}
          usesh: true
          prepare: |
            pkg install -y git gmake php83 python311
          run: |
            set -e
            WORKDIR=$(pwd)
            BRANCH="${{ env.OPNSENSE_BRANCH }}"
            
            # Clone OPNsense plugins repository for build infrastructure
            git clone --depth 1 --branch "$BRANCH" https://github.com/opnsense/plugins.git /tmp/plugins
            
            # Create plugin directory and copy source
            mkdir -p /tmp/plugins/net/singbox
            cp -r "$WORKDIR"/* /tmp/plugins/net/singbox/
            
            # Build the plugin package
            cd /tmp/plugins/net/singbox
            make package
            
            # Copy built package back to workspace
            mkdir -p "$WORKDIR/dist"
            cp work/pkg/*.pkg "$WORKDIR/dist/"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: opnsense-singbox-plugin
          path: dist/*.pkg
          if-no-files-found: error

      - name: Create release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.pkg
          generate_release_notes: true
